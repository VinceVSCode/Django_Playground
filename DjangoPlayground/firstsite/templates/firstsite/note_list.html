{% extends "firstsite/base.html" %}
{% block title %}Your Notes{% endblock %}

{% block content %}
  <div class="card" style="margin-bottom:1rem;">
    <h1 style="margin:0;">Your Notes</h1>
    <p class="muted" style="margin:.25rem 0 0;">View, filter, and manage your notes.</p>
  </div>
<div class="filter-bar">
  <form method="get" style="display:flex; gap:1rem; flex-wrap:wrap; align-items:end; width:100%;">
    <input type="text" name="search" placeholder="Search…" value="{{ values.search|default:'' }}" />

    <select name="tag">
      <option value="">— All tags —</option>
      {% for t in tags %}
        <option value="{{ t.id }}" {% if values.tag == t.id|stringformat:"s" %}selected{% endif %}>{{ t.name }}</option>
      {% endfor %}
    </select>

    <label>
      <input type="checkbox" name="untagged" value="1" {% if values.untagged == '1' %}checked{% endif %}/>
      Untagged only
    </label>

    <label>
      Pinned:
      <select name="pinned">
        <option value="">All</option>
        <option value="1" {% if values.pinned == '1' %}selected{% endif %}>Yes</option>
        <option value="0" {% if values.pinned == '0' %}selected{% endif %}>No</option>
      </select>
    </label>

    <label>
      Archived:
      <select name="archived">
        <option value="">All</option>
        <option value="0" {% if values.archived == '0' %}selected{% endif %}>No</option>
        <option value="1" {% if values.archived == '1' %}selected{% endif %}>Yes</option>
      </select>
    </label>
    <label>
      Date field:
      <select name="date_field">
        <option value="updated" {% if values.date_field == 'updated' or not values.date_field %}selected{% endif %}>Updated</option>
        <option value="created" {% if values.date_field == 'created' %}selected{% endif %}>Created</option>
      </select>
    </label>

    <label>
      From:
      <input type="date" name="from" value="{{ values.from|default:'' }}">
    </label>

    <label>
      To:
      <input type="date" name="to" value="{{ values.to|default:'' }}">
    </label>

    <label>
      Sort by:
      <select name="sort">
        <option value="updated" {% if values.sort == 'updated' or not values.sort %}selected{% endif %}>Updated</option>
        <option value="created" {% if values.sort == 'created' %}selected{% endif %}>Created</option>
        <option value="title"   {% if values.sort == 'title' %}selected{% endif %}>Title</option>
      </select>
    </label>

    <label>
      Direction:
      <select name="dir">
        <option value="desc" {% if values.dir == 'desc' or not values.dir %}selected{% endif %}>Desc</option>
        <option value="asc"  {% if values.dir == 'asc' %}selected{% endif %}>Asc</option>
      </select>
    </label>


    <div class="filter-actions">
    <button class="button" type="submit">Apply</button>
    <a class="button" href="{% url 'note_lists' %}">Reset</a>
  </div>
  </form>
</div>

{% if not page_obj.object_list %}
  <div class="card" style="text-align:center;">
    <p class="muted">No notes match your filters.</p>
    <p><a class="button" href="{% url 'create_note' %}">Create your first note</a></p>
  </div>
{% endif %}

{% if page_obj.object_list %}
<div class="notes-grid">
    {% for note in page_obj.object_list %}
      <article class="note-card">
        <div class="note-card__meta">
          {% if note.is_pinned %}<span class="note-pin">Pinned</span>{% endif %}
          {% if note.is_archived %}<span class="note-pin">Archived</span>{% endif %}
          <span>Updated {{ note.updated_at|date:"Y-m-d H:i" }}</span>
        </div>

        <h3 class="note-card__title">
          <a href="{% url 'note_detail' note.pk %}" class="topbar__link">{{ note.title }}</a>
        </h3>

        <div class="muted">{{ note.content|truncatechars:120 }}</div>

        {% if note.tags.exists %}
          <div class="chips" style="margin-top:.4rem;">
            {% for tag in note.tags.all %}
              <span class="chip">{{ tag.name }}</span>
            {% endfor %}
          </div>
        {% endif %}

        <div style="margin-top:.6rem; display:flex; gap:.4rem; flex-wrap:wrap;">
          <a class="button" href="{% url 'note_detail' note.pk %}">View</a>
          <a class="button" href="{% url 'note_edit' note.pk %}">Edit</a>
          <a class="button" href="{% url 'note_delete' note.pk %}">Delete</a>

          <form action="{% url 'note_toggle_pin' note.pk %}" method="post" class="inline">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="button" type="submit">{% if note.is_pinned %}Unpin{% else %}Pin{% endif %}</button>
          </form>

          <form action="{% url 'note_toggle_archive' note.pk %}" method="post" class="inline">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="button" type="submit">{% if note.is_archived %}Restore{% else %}Archive{% endif %}</button>
          </form>
        </div>
      </article>
    {% endfor %}
  </div>

  {# --- numbered pager goes here (next step) --- #}
{% if page_obj.paginator.num_pages > 1 %}
  <nav class="pagination">
    {# First / Prev #}
    {% if page_obj.has_previous %}
      <a class="button" href="?{% if querystring %}{{ querystring }}&{% endif %}page=1">« First</a>
      <a class="button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">‹ Prev</a>
    {% endif %}

    {# Windowed page numbers with ellipses (no parentheses in conditions) #}
    {% for num in page_obj.paginator.page_range %}
      {% if num == 1 or num == page_obj.paginator.num_pages or num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
        {% if num == page_obj.number %}
          <span class="button" style="font-weight:bold;">{{ num }}</span>
        {% else %}
          <a class="button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ num }}">{{ num }}</a>
        {% endif %}
      {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
        <span class="muted">…</span>
      {% endif %}
    {% endfor %}

    {# Next / Last #}
    {% if page_obj.has_next %}
      <a class="button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Next ›</a>
      <a class="button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.paginator.num_pages }}">Last »</a>
    {% endif %}
  </nav>
{% endif %}


{% else %}
  <p>No notes match your filters.</p>
{% endif %}

{% endblock %}
