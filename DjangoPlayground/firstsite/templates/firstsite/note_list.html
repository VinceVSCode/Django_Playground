{% extends "firstsite/base.html" %}
{% block title %}Your Notes{% endblock %}

{% block content %}
<h1>Your Notes</h1>

<form method="get" style="margin-bottom:1rem">
  <input type="text" name="search" placeholder="Search…" value="{{ values.search|default:'' }}" />

  <select name="tag">
    <option value="">— All tags —</option>
    {% for t in tags %}
      <option value="{{ t.id }}" {% if values.tag == t.id|stringformat:"s" %}selected{% endif %}>{{ t.name }}</option>
    {% endfor %}
  </select>

  <label>
    <input type="checkbox" name="untagged" value="1" {% if values.untagged == '1' %}checked{% endif %}/>
    Untagged only
  </label>

  <label>
    Pinned:
    <select name="pinned">
      <option value="">All</option>
      <option value="1" {% if values.pinned == '1' %}selected{% endif %}>Yes</option>
      <option value="0" {% if values.pinned == '0' %}selected{% endif %}>No</option>
    </select>
  </label>

  <label>
    Archived:
    <select name="archived">
      <option value="">All</option>
      <option value="0" {% if values.archived == '0' %}selected{% endif %}>No</option>
      <option value="1" {% if values.archived == '1' %}selected{% endif %}>Yes</option>
    </select>
  </label>
  <label>
    Date field:
    <select name="date_field">
      <option value="updated" {% if values.date_field == 'updated' or not values.date_field %}selected{% endif %}>Updated</option>
      <option value="created" {% if values.date_field == 'created' %}selected{% endif %}>Created</option>
    </select>
  </label>

  <label>
    From:
    <input type="date" name="from" value="{{ values.from|default:'' }}">
  </label>

  <label>
    To:
    <input type="date" name="to" value="{{ values.to|default:'' }}">
  </label>

  <label>
    Sort by:
    <select name="sort">
      <option value="updated" {% if values.sort == 'updated' or not values.sort %}selected{% endif %}>Updated</option>
      <option value="created" {% if values.sort == 'created' %}selected{% endif %}>Created</option>
      <option value="title"   {% if values.sort == 'title' %}selected{% endif %}>Title</option>
    </select>
  </label>

  <label>
    Direction:
    <select name="dir">
      <option value="desc" {% if values.dir == 'desc' or not values.dir %}selected{% endif %}>Desc</option>
      <option value="asc"  {% if values.dir == 'asc' %}selected{% endif %}>Asc</option>
    </select>
  </label>


  <button type="submit">Apply</button>
  <a href="{% url 'note_lists' %}">Reset</a>
</form>

{% if not page_obj.object_list %}
  <div class="card" style="text-align:center;">
    <p class="muted">No notes match your filters.</p>
    <p><a class="button" href="{% url 'create_note' %}">Create your first note</a></p>
  </div>
{% endif %}

{% if page_obj.object_list %}
  <ul>
    {% for note in page_obj.object_list %}
        <div style="margin-top:.5rem">
      <a class="button" href="{% url 'note_detail' note.pk %}">View</a>
      <a class="button" href="{% url 'note_edit' note.pk %}">Edit</a>
      <a class="button" href="{% url 'note_delete' note.pk %}">Delete</a>

      <form action="{% url 'note_toggle_pin' note.pk %}" method="post" class="inline">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path }}">
        <button class="button" type="submit">{% if note.is_pinned %}Unpin{% else %}Pin{% endif %}</button>
      </form>

      <form action="{% url 'note_toggle_archive' note.pk %}" method="post" class="inline">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path }}">
        <button class="button" type="submit">{% if note.is_archived %}Restore{% else %}Archive{% endif %}</button>
      </form>
    </div>

      <li class="card">
        <strong>
          <a href="{% url 'note_detail' note.pk %}">{{ note.title }}</a>
        </strong>
        {% if note.is_pinned %}<em> (Pinned)</em>{% endif %}
        {% if note.is_archived %}<em> (Archived)</em>{% endif %}
        <div class="muted">{{ note.content|truncatechars:120 }}</div>
        {% if note.tags.exists %}
          <div>
            <small>Tags:
              {% for tag in note.tags.all %}
                <span class="tagpill">{{ tag.name }}</span>
              {% endfor %}
            </small>
          </div>
        {% endif %}
      </li>
    {% endfor %}
  </ul>

  {# --- numbered pager goes here (next step) --- #}
{% if page_obj.paginator.num_pages > 1 %}
  <nav class="pagination">
    {# First / Prev #}
    {% if page_obj.has_previous %}
      <a class="button" href="?{% if querystring %}{{ querystring }}&{% endif %}page=1">« First</a>
      <a class="button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">‹ Prev</a>
    {% endif %}

    {# Windowed page numbers with ellipses (no parentheses in conditions) #}
    {% for num in page_obj.paginator.page_range %}
      {% if num == 1 or num == page_obj.paginator.num_pages or num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
        {% if num == page_obj.number %}
          <span class="button" style="font-weight:bold;">{{ num }}</span>
        {% else %}
          <a class="button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ num }}">{{ num }}</a>
        {% endif %}
      {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
        <span class="muted">…</span>
      {% endif %}
    {% endfor %}

    {# Next / Last #}
    {% if page_obj.has_next %}
      <a class="button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Next ›</a>
      <a class="button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.paginator.num_pages }}">Last »</a>
    {% endif %}
  </nav>
{% endif %}


{% else %}
  <p>No notes match your filters.</p>
{% endif %}

{% endblock %}
